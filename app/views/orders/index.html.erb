<% if @order.present? %>
    <%= render "orders/modals/add_order_entries" %>
    <%= render "orders/modals/edit_order_entries" %>
    <%= render "orders/modals/manage_users" %>
    <%= render "orders/modals/item_details" %>
    <%= render "orders/modals/edit_attributes" %>
    <%= render "orders/modals/entry_history" %>
    <%= render "orders/modals/edit_free_flowing_fields" %>
    <%= render "orders/modals/file_upload" %>
<% end %>
<% if @order.present? && @orders.present? %>
    <div class="row" style="position:relative;">
      <div id="left" class="col-lg-3 orders_and_order_form" style="overflow-y: hidden; overflow-x: hidden; padding-bottom: 5% !important; flex: 0 0 30% !important; max-width: 30% !important;">
        <div class="d-flex flex-row justify-content-center">
          <div class="btn__add--project mr-3 d-none">
            <a href="<%= new_order_path %>" class="btn btn-dark btn-padding-margin" style="margin: 0% 1%;padding: .2% 3% !important;">
              ADD A PROJECT
            </a>
          </div>
          <div class="search-box">
            <%= form_for :search, url: { action: :index }, html: { method: :get }, remote: false do |f| %>
              <div class="input-group mb-3">
                <%= f.search_field :term, class: 'form-control', placedholder: 'Search...' %>
                <div class="input-group-append">
                  <div class="btn-group">
                    <%= f.button class: 'btn btn-dark' do %>
                      <i data-feather="search"></i>
                    <% end %>
                    <div class="btn-group">
                      <button class="btn btn-dark dropdown-toggle" type="button" id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                        <i class="align-middle" data-feather="filter"></i>SORT BY</a>
                        <i class="fa fa-caret-down"></i>
                      </button>
                      <div class="dropdown-menu" aria-labelledby="dropdownMenuButton">
                        <%= link_to 'Latest', { sort: 'created_at', direction: 'desc', search: { term: @search.term } }, class: 'dropdown-item' %>
                        <%= link_to 'Oldest', { sort: 'created_at', direction: 'asc', search: { term: @search.term } }, class: 'dropdown-item' %>
                        <%= link_to 'Ticket # Asc', { sort: 'id', direction: 'asc', search: { term: @search.term } }, class: 'dropdown-item' %>
                        <%= link_to 'Ticket # Desc', { sort: 'id', direction: 'desc', search: { term: @search.term } }, class: 'dropdown-item' %>
                        <%= link_to 'Brand', { sort: 'brand', direction: 'asc', search: { term: @search.term } }, class: 'dropdown-item' %>
                        <%= link_to 'Update Date', { sort: 'updated_at', direction: 'desc', search: { term: @search.term } }, class: 'dropdown-item' %>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            <% end %>
          </div>
        </div>
        <nav style="margin-top: 15px;">
          <div class="nav nav-tabs" id="nav-tab" role="tablist">
            <a class="nav-item nav-link active" data-toggle="tab" href="#nav-orders">Orders</a>
            <a class="nav-item nav-link" data-toggle="tab" href="#nav-messages">Messages</a>
            <a class="nav-item nav-link" data-toggle="tab" href="#nav-notifications">Notifications</a>
          </div>
        </nav>
        <div class="tab-content" id="nav-tabContent">
          <div class="tab-pane active" id="nav-orders">
            <div class="row">
              <div class="col orders_and_order_form_2" style="overflow-y: auto; overflow-x: hidden; padding-bottom: 5% !important; flex: 0 0 100% !important;">
                <% @orders.each do |order| %>
                    <%= link_to order_path(order), class: "order-link", remote: true do %>
                        <div id="order-<%= order.id %>" class="card mb-3" style="box-shadow: 0 5px 15px rgba(33, 33, 33, .4);" >
                          <div class="card-body bg-light text-secondary">
                            <div class="row">
                              <div class="col-12">
                                <p class="lead">
                                  <%= order.brand_branches %>
                                </p>
                                <h4><%= order.brand_name %></h4>
                                <p class="lead">
                                  ORDER TICKET #<%= order.id %>
                                </p>
                              </div>
                            </div>
                          </div>
                          <div class="card-footer" style="text-transform: uppercase;">
                            <%= order.created_date %> BY <%= order.created_by_name %>
                          </div>
                        </div>
                    <% end %>
                <% end %>
              </div>
            </div>
          </div>
          <div class="tab-pane" id="nav-messages">
            <div class="row">
              
                <div class="ibox" style="padding: 15px; width: 100%;">
                  <div class="ibox-title" style="border:none; padding-top: 0;">
                    <div id="message_items">
                      <%= render 'message_items', order: @order, chatroom: @chatroom_order  %>
                    </div>
                  </div>
                  <div class="ibox-content" id="order_messages" style="padding-left: 0;">
                    <div id="order_messages">
                      <%= render 'chatroom_tab', chatroom: @chatroom_order  %>
                    </div>
                  </div>
                  <div class="ibox-footer">
                      <div class="chat-message-form" id="chatroom_message">
                        <%= render '/chatroom_orders/chatroom_message', chatroom: @chatroom_order %>
                      </div>
                  </div>
                </div>
                
            </div>
          </div>
          <div class="tab-pane" id="nav-notifications">
            <div class="row">
              <div class="col orders_and_order_form_2" style="overflow-y: auto; overflow-x: hidden; padding-bottom: 5% !important; flex: 0 0 100% !important;">
                <table class="table table-striped">
                  <tbody>
                    <% if @order_histories.present? %>
                        <% @order_histories.each do |history| %>
                          <tr>
                            <th><%= generate_history_information(history) %></th>
                          </tr>
                        <% end %>
                    <% else %>
                        <tr>
                          <th><b>No Notifications Yet.</b></th>
                        </tr>
                    <% end %>

                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

      </div>

      <div class="col padding-left orders_and_order_form" style="overflow-y: auto; overflow-x: hidden">
        <div id="show_order">
          <%= render 'show_order', order: @order, chatroom_order: @chatroom_order, order_entries: @order_entries %>
        </div>
      </div>

    </div>
<% else %>
    <style>
        #wrapper-div{width:100%; height:400px}
        .sample{height:20px; position:relative; margin: -20px -50px; width:150px; top:50%; left:50%;}
    </style>

    <div class="row" style="position:relative;">
      <div class="col padding-left orders_and_order_form" style="overflow-y: auto; overflow-x: hidden">
        <div class="row">
          <div class="col padding-left" id="wrapper-div">
            <a href="<%= new_order_path %>" class="sample" style="text-align: center;"><i class="fa fa-plus-circle fa-5" aria-hidden="true" style="font-size: 5em;"></i><br/>Add New Quote</a>
          </div>
        </div>
      </div>
    </div>
<% end %>


<script type="text/javascript">

    $('#new_order_entry').submit(function() {
        return setAttributesOnForm($(this));
    });

    $('#edit_order_entry').submit(function() {
        return setAttributesOnForm($(this));
    });

    Dropzone.options.pictureUpload = {
        maxFiles:1,
        success: function(file, response) {
            $('#pictureUpload').modal('hide')
            this.removeFile(file);
            var order_entry_id = $('#order_entry_id_2').val();
            var pic_id = 'pic' + order_entry_id + response.id
            $("#pic1").attr("src",response.picture_url);
            $("#"+pic_id).attr("src",response.picture_url);
        }
    };
    $(function(){
        $("div#order-<%= @order.id %>").addClass('orange-left');
        $('.ibox-content').slimScroll({
          railOpacity: 0.4,
          start: 'bottom',
          height: '500px',
        });
        
        $("div#order-<%= params[:order_id] %>").click();
        $("#order-<%= params[:order_id] %>")[0].scrollIntoView({
            behavior: "smooth", // or "auto" or "instant"
            block: "start" // or "end"
        });
    });
</script>

<% if @product_id.present? && @order_entry_id.present? %>
    <script type="text/javascript">
        itemDetails(<%= @product_id %>, '<%= @order_entry_id %>');
    </script>
<% end %>
